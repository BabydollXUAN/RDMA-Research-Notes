**GitHub ä»£ç åº“**ï¼šhttps://github.com/spcl/Uno_SC25.git


## Simulator:Â `sim/`

`sim`Â is a modified version of theÂ **htsim**Â datacenter simulator. The  
binaryÂ `sim/datacenter/htsim_lcp_entry_modern`Â is invoked by the Python  
and shell scripts; it reads commandâ€‘line options, loads a topology and  
traffic matrix, then instantiates sources and sinks that send flows  
between hosts.
`sim` æ˜¯å¯¹ **htsim** æ•°æ®ä¸­å¿ƒæ¨¡æ‹Ÿå™¨çš„ä¿®æ”¹ç‰ˆæœ¬ã€‚è¿™äºŒè¿›åˆ¶æ–‡ä»¶`sim/datacenter/htsim_lcp_entry_modern` ç”± Python å’Œ shell è„šæœ¬è°ƒç”¨ï¼›å®ƒè¯»å–å‘½ä»¤è¡Œé€‰é¡¹ï¼ŒåŠ è½½æ‹“æ‰‘ç»“æ„å’Œæµé‡çŸ©é˜µï¼Œç„¶åå®ä¾‹åŒ–æºå’Œå®¿èŠ‚ç‚¹ï¼Œä½¿ä¸»æœºä¹‹é—´å‘é€æµã€‚

çœ‹çœ‹é‡Œé¢æ˜¯ waf è¿˜æ˜¯ ns3 è„šæœ¬ ls -F
## Q&Aï¼š
### 1. (base) ustc@xuningunon1-3317:/$ nvidia-smi
NVIDIA-SMI has failed because it couldn't communicate with the NVIDIA driver. Make sure that the latest NVIDIA driver is installed and running.å‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯æ²¡æœ‰GPUé©±åŠ¨å—

æ˜¯çš„ï¼Œå‡ºç°è¿™ä¸ªæŠ¥é”™é€šå¸¸æ„å‘³ç€**ç³»ç»Ÿè™½ç„¶è¯†åˆ«åˆ°äº† GPU ç¡¬ä»¶ï¼Œä½†æ²¡æœ‰æ­£ç¡®åŠ è½½æˆ–å®‰è£…ä¸ä¹‹åŒ¹é…çš„ NVIDIA é©±åŠ¨ç¨‹åº**ã€‚

åœ¨ CENI çš„è™šæ‹Ÿæœºç¯å¢ƒä¸‹ï¼Œè¿™ç§æƒ…å†µé€šå¸¸æœ‰ä¸‰ç§å¯èƒ½ï¼š

1. **å®Œå…¨æ²¡è£…é©±åŠ¨**ï¼šè¿™æ˜¯ä¸€ä¸ªçº¯å‡€é•œåƒï¼Œéœ€è¦ä½ æ‰‹åŠ¨å®‰è£…ã€‚
    
2. **é©±åŠ¨æŒ‚äº†**ï¼šä¹‹å‰è£…è¿‡ï¼Œä½†å› ä¸ºå†…æ ¸æ›´æ–°ï¼ˆKernel Updateï¼‰å¯¼è‡´é©±åŠ¨å¤±æ•ˆã€‚
    
3. **é©±åŠ¨ä¸å†…æ ¸ä¸å…¼å®¹**ï¼šå®‰è£…çš„ç‰ˆæœ¬ä¸å¯¹ã€‚

### 2.


è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å­¦ä¹ æ€åº¦ï¼ä½œä¸ºç ”ä¸€å­¦ç”Ÿï¼Œ**è¯»ä»£ç **å’Œ**æ”¹å‚æ•°è·‘å®éªŒ**æ˜¯ç†è§£ä¸€ç¯‡é¡¶ä¼šè®ºæ–‡ï¼ˆSC/SIGCOMM/NSDIï¼‰æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªæŠ“æ‰‹ã€‚

Uno è¿™ä¸ªé¡¹ç›®çš„ä»£ç ç»“æ„æ¯”è¾ƒç»å…¸ï¼ˆåŸºäº htsim ä»¿çœŸå™¨ï¼‰ï¼Œæˆ‘ä¸ºä½ æ•´ç†äº†ä¸€æ¡**â€œç”±æµ…å…¥æ·±â€**çš„å­¦ä¹ è·¯å¾„ï¼Œå¸®åŠ©ä½ ç»“åˆè‡ªå·±çš„å¹¿åŸŸ RDMA æ–¹å‘åšä¸€äº›è¡¥å……å®éªŒã€‚

---

### ç¬¬ä¸€é˜¶æ®µï¼šä»£ç é˜…è¯»ï¼ˆæœ‰çš„æ”¾çŸ¢ï¼Œä¸è¦é€šè¯»ï¼‰

ä¸è¦è¯•å›¾ä»å¤´è¯»åˆ°å°¾ï¼Œå»ºè®®ä½¿ç”¨ **VS Code** çš„â€œè·³è½¬åˆ°å®šä¹‰â€ï¼ˆCtrl + Click / F12ï¼‰åŠŸèƒ½ï¼ŒæŒ‰ä»¥ä¸‹é€»è¾‘è¿½è¸ªï¼š

#### 1. æ‰¾åˆ°â€œå…¥å£â€ï¼š`sim/datacenter/main_*.cpp`

ä½ åˆšæ‰è·‘çš„è„šæœ¬é‡Œè°ƒç”¨çš„æ˜¯ `htsim_lcp_entry_modern` æˆ– `htsim_uec_entry_modern`ã€‚

- **å»å“ªçœ‹**ï¼šæ‰“å¼€ `sim/datacenter/main_lcp_entry_modern.cpp` (æˆ–ç±»ä¼¼å‘½åçš„ main æ–‡ä»¶)ã€‚
    
- **çœ‹ä»€ä¹ˆ**ï¼šè¿™é‡Œæ˜¯è§£æå‘½ä»¤è¡Œå‚æ•°ï¼ˆæ¯”å¦‚ `-interdcDelay`ï¼‰çš„åœ°æ–¹ã€‚ä½ å¯ä»¥çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•å»ºç«‹ç½‘ç»œæ‹“æ‰‘ã€åˆå§‹åŒ– Loggersï¼ˆè®°å½•æ•°æ®çš„ç»„ä»¶ï¼‰çš„ã€‚
    

#### 2. æ‰¾åˆ°â€œæ ¸å¿ƒç®—æ³•â€ï¼š`sim/datacenter/uec.cpp` (æˆ– `lcp.cpp`)

è¿™æ˜¯ Uno/UEC åè®®çš„**çµé­‚**æ‰€åœ¨ã€‚æ‹¥å¡æ§åˆ¶ç®—æ³•çš„æ‰€æœ‰é€»è¾‘éƒ½åœ¨è¿™é‡Œã€‚

- **é‡ç‚¹å…³æ³¨å‡½æ•°**ï¼š
    
    - `receivePacket()`: å½“å‘é€ç«¯æ”¶åˆ° ACK æˆ– NACK æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ
        
    - `adjust_window()`: **è¿™æ˜¯æœ€å…³é”®çš„**ã€‚çœ‹å®ƒå¦‚ä½•æ ¹æ®æ˜¾å¼æ‹¥å¡é€šçŸ¥ï¼ˆECNï¼‰æˆ–ä¸¢åŒ…æ¥å¢åŠ æˆ–å‡å°‘æ‹¥å¡çª—å£ï¼ˆCwndï¼‰ã€‚
        
    - `process_ack()`: å¤„ç†å›åŒ…é€»è¾‘ã€‚
        

#### 3. æ‰¾åˆ°â€œæ•°æ®åŒ…å®šä¹‰â€ï¼š`sim/datacenter/uecpacket.h`

- **çœ‹ä»€ä¹ˆ**ï¼šçœ‹ Packet Header é‡ŒåŠ äº†å“ªäº›å­—æ®µï¼Ÿæ¯”å¦‚ Uno å¯èƒ½ä¼šåœ¨åŒ…å¤´é‡Œæºå¸¦â€œè·¯å¾„è´Ÿè½½ä¿¡æ¯â€æˆ–â€œç²¾ç¡®çš„æ—¶é—´æˆ³â€ï¼Œè¿™å¯¹ç†è§£å®ƒæ˜¯å¦‚ä½•æ„ŸçŸ¥æ‹¥å¡çš„å¾ˆæœ‰å¸®åŠ©ã€‚
    

---

### ç¬¬äºŒé˜¶æ®µï¼šè®¾è®¡è¡¥å……å®éªŒï¼ˆæ§åˆ¶å˜é‡æ³•ï¼‰

æ—¢ç„¶ä½ çš„æ–¹å‘æ˜¯ **â€œå¹¿åŸŸ RDMA (WAN-RDMA)â€**ï¼Œå»ºè®®ä½ ä» `sc25_quick_validation.sh` è„šæœ¬å…¥æ‰‹ï¼Œå¤åˆ¶ä¸€ä»½å‡ºæ¥é­”æ”¹ã€‚

**å‡†å¤‡å·¥ä½œï¼š**

Bash

```
cp sc25_quick_validation.sh my_wan_experiment.sh
chmod +x my_wan_experiment.sh
```

ç”¨ VS Code æ‰“å¼€ `my_wan_experiment.sh`ï¼Œæ‰¾åˆ°é‚£ä¸€é•¿ä¸²è¿è¡Œå‘½ä»¤ã€‚

#### å®éªŒ Aï¼šæ¢ç©¶â€œé•¿å»¶è¿Ÿâ€å¯¹ååé‡çš„å½±å“ (Latency Sensitivity)

å¹¿åŸŸç½‘æœ€å¤§çš„ç‰¹ç‚¹æ˜¯ RTT (å¾€è¿”æ—¶å»¶) å¤§ã€‚

- **ä¿®æ”¹å‚æ•°**ï¼šæ‰¾åˆ° `-interdcDelay 886500` (å•ä½é€šå¸¸æ˜¯çš®ç§’æˆ–çº³ç§’ï¼Œè¿™é‡Œçº¦ 886us)ã€‚
    
- **æ€ä¹ˆåš**ï¼š
    
    - è®¾ç½®ä¸‰ä¸ªæ¢¯åº¦ï¼š`100000` (çŸ­è·), `1000000` (ä¸­è·), `10000000` (è·¨å›½é•¿è·)ã€‚
        
    - åˆ†åˆ«è¿è¡Œï¼Œè®°å½•ç»“æœã€‚
        
- **é¢„æœŸè§‚å¯Ÿ**ï¼šæ™®é€šç®—æ³•ï¼ˆå¦‚ RoCE DCQCNï¼‰åœ¨é•¿å»¶è¿Ÿä¸‹ååé‡ä¼šå‰§çƒˆæŠ–åŠ¨ï¼Œè€Œ Uno åº”è¯¥èƒ½ä¿æŒç¨³å®šã€‚è¿™æ˜¯ä½ è®ºæ–‡é‡Œå¾ˆå¥½çš„ Motivation å›¾ã€‚
    

#### å®éªŒ Bï¼šæ¢ç©¶â€œå¸¦å®½åˆ©ç”¨ç‡â€ä¸â€œä¸¢åŒ…â€çš„å…³ç³»

- **ä¿®æ”¹å‚æ•°**ï¼šä¿®æ”¹ `-queueSizeRatio` æˆ– `-forceQueueSize`ã€‚
    
- **æ€ä¹ˆåš**ï¼šæŠŠäº¤æ¢æœºé˜Ÿåˆ—è®¾å¾—éå¸¸å°ï¼ˆæ¨¡æ‹Ÿæµ…ç¼“å­˜äº¤æ¢æœºï¼‰ï¼Œçœ‹çœ‹ Uno ä¼šä¸ä¼šå› ä¸º Buffer æº¢å‡ºè€Œå¯¼è‡´ä¸¢åŒ…é‡ä¼ ï¼Œè¿›è€Œæ€§èƒ½å´©å¡Œã€‚
    

---

### ç¬¬ä¸‰é˜¶æ®µï¼šä»£ç â€œåŸ‹ç‚¹â€è§‚å¯Ÿï¼ˆPrintf Debuggingï¼‰

è¿™æ˜¯ç†è§£ç®—æ³•åŠ¨æ€è¿‡ç¨‹æœ€ç›´è§‚çš„æ–¹æ³•ã€‚

1. **ä¿®æ”¹ä»£ç **ï¼š
    
    æ‰“å¼€ `sim/datacenter/uec.cpp`ï¼Œåœ¨ `adjust_window` å‡½æ•°é‡ŒåŠ ä¸€è¡Œæ‰“å°ï¼š
    
    C++
    
    ```
    // ä¼ªä»£ç ç¤ºä¾‹
    if (cwnd_changed) {
       printf("Time: %lu, Node: %d, OldCwnd: %d, NewCwnd: %d, Reason: %s\n", 
              eventlist().now(), _id, old_cwnd, _cwnd, "ECN_Congestion");
    }
    ```
    
2. **é‡æ–°ç¼–è¯‘**ï¼š
    
    Bash
    
    ```
    cd ~/Uno_Project/sim/datacenter
    make -j4
    ```
    
3. **è¿è¡Œè„šæœ¬å¹¶é‡å®šå‘**ï¼š
    
    Bash
    
    ```
    ./htsim_uec_entry ... > my_debug_log.txt
    ```
    
4. **åˆ†ææ—¥å¿—**ï¼š
    
    ä½ å¯ä»¥çœ‹åˆ° Cwnd éšæ—¶é—´å˜åŒ–çš„ç²¾ç¡®æ•°å€¼ï¼Œè¿™æ¯”çœ‹æœ€åçš„ç»Ÿè®¡å›¾æ›´èƒ½è®©ä½ ç†è§£ç®—æ³•çš„â€œå¾®æ“â€ã€‚
    

---

### ğŸ’¡ ä¸€ä¸ªé’ˆå¯¹ä½ æ¯•ä¸šè®ºæ–‡çš„å»ºè®®

æ—¢ç„¶ä½ æ˜¯ç ”ä¸€ï¼Œç°åœ¨åš**â€œå¤ç°+å¾®è°ƒâ€**æ˜¯æ€§ä»·æ¯”æœ€é«˜çš„ã€‚

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®ï¼š**

1. **ç”»ä¸€å¼ å›¾**ï¼šå°è¯•æŠŠä½ åˆšæ‰ç”Ÿæˆçš„ `artifact_results/fig3/uno_rate.dat` æ•°æ®ï¼Œè‡ªå·±ç”¨ Python (`matplotlib`) ç”»ä¸€éã€‚ä¸è¦ç”¨è„šæœ¬ç”»ï¼Œè‡ªå·±å†™ä»£ç è¯»æ•°æ®ç”»å›¾ï¼Œè¿™æ ·ä½ ä»¥åå°±èƒ½éšå¿ƒæ‰€æ¬²åœ°å±•ç¤ºæ•°æ®äº†ã€‚
    
2. **æ”¹ä¸€ä¸ªå‚æ•°**ï¼šç°åœ¨å°±å»æŠŠ `-interdcDelay` å¢å¤§ 10 å€ï¼Œçœ‹çœ‹ Uno è¿˜èƒ½ä¸èƒ½è·‘æ»¡å¸¦å®½ï¼Ÿ
    

éœ€è¦æˆ‘ç»™ä½ æä¾›ä¸€ä¸ªç®€å•çš„ **Python ç”»å›¾è„šæœ¬æ¨¡æ¿**ï¼Œç”¨æ¥è¯»å– `.dat` æ–‡ä»¶å¹¶ç”»å‡ºååé‡æ›²çº¿å—ï¼Ÿ
## **Phantom Queuesï¼ˆå¹»å½±é˜Ÿåˆ—ï¼‰** çš„è¯¦ç»†ä»£ç é€»è¾‘è§£æã€‚

åœ¨ Uno çš„è®¾è®¡ä¸­ï¼Œå¹»å½±é˜Ÿåˆ—æ˜¯éƒ¨ç½²åœ¨**äº¤æ¢æœºï¼ˆSwitchï¼‰**ä¾§çš„æœºåˆ¶ã€‚å®ƒçš„æ ¸å¿ƒç›®çš„æ˜¯åœ¨ç‰©ç†é˜Ÿåˆ—ï¼ˆPhysical Queueï¼‰è¢«å¡«æ»¡ä¹‹å‰æå‰æ„ŸçŸ¥æ‹¥å¡ï¼Œå¹¶ä¸ºé•¿ RTT çš„è·¨æ•°æ®ä¸­å¿ƒï¼ˆInter-DCï¼‰æµé‡æä¾›è¶³å¤Ÿå¤§çš„è™šæ‹Ÿç¼“å†²ç©ºé—´æ¥å®¹çº³ BDPï¼ˆå¸¦å®½æ—¶å»¶ç§¯ï¼‰ã€‚


---

### 1. æ ¸å¿ƒæ•°æ®ç»“æ„ (Data Structures)

åœ¨ `htsim` çš„é˜Ÿåˆ—ç±»ï¼ˆä¾‹å¦‚ `Queue` æˆ– `CompositeQueue`ï¼‰ä¸­ï¼Œé™¤äº†ç»´æŠ¤ç°æœ‰çš„ç‰©ç†åŒ…åˆ—è¡¨å¤–ï¼Œä½ éœ€è¦å¢åŠ ä¸€ç»„ç”¨äºç»´æŠ¤å¹»å½±é˜Ÿåˆ—çŠ¶æ€çš„å˜é‡ã€‚

C++

```
class Queue {
    // === ç‰©ç†é˜Ÿåˆ—çŠ¶æ€ (ç°æœ‰) ===
    uint64_t _bytes_in_queue; // ç‰©ç†é˜Ÿåˆ—å½“å‰çš„å­—èŠ‚æ•°
    uint64_t _max_buffer_size; // ç‰©ç†ç¼“å­˜ä¸Šé™ (e.g., 1MB)

    // === å¹»å½±é˜Ÿåˆ—çŠ¶æ€ (æ–°å¢) ===
    double _phantom_bytes;      // å¹»å½±é˜Ÿåˆ—å½“å‰çš„è™šæ‹Ÿå­—èŠ‚æ•° (ä½¿ç”¨ double ä»¥ä¾¿ç²¾ç¡®è®¡ç®—æµå‡º)
    uint64_t _phantom_max_size; // å¹»å½±é˜Ÿåˆ—çš„è™šæ‹Ÿå®¹é‡ (è®¾ç½®ä¸º Inter-DC BDP, e.g., 500MB)
    
    // === æ—¶é—´ä¸é€Ÿç‡ ===
    simtime_picoseconds _last_update_time; // ä¸Šæ¬¡æ›´æ–°å¹»å½±é˜Ÿåˆ—çš„æ—¶é—´æˆ³
    uint64_t _link_rate;        // ç‰©ç†é“¾è·¯é€Ÿç‡ (e.g., 100Gbps)
    double _drain_rate_factor;  // æ’æ°´é€Ÿç‡å› å­ (Uno è®ºæ–‡è®¾å®šä¸º 0.9) 
};
```

### 2. å…³é”®é€»è¾‘ï¼šæ›´æ–°ä¸å…¥é˜Ÿ (Update & Enqueue)

å¹»å½±é˜Ÿåˆ—å¹¶ä¸çœŸæ­£å­˜å‚¨æ•°æ®åŒ…ï¼Œå®ƒåªæ˜¯ä¸€ä¸ª**è®¡æ•°å™¨**ã€‚è¿™ä¸ªè®¡æ•°å™¨çš„å¢å‡é€»è¾‘æ˜¯å…¶çµé­‚æ‰€åœ¨ã€‚

#### A. æ’æ°´é€»è¾‘ (Draining Logic)

æ¯å½“æœ‰æ“ä½œï¼ˆå¦‚åŒ…åˆ°è¾¾æˆ–åŒ…ç¦»å¼€ï¼‰å‘ç”Ÿæ—¶ï¼Œé¦–å…ˆè¦æ ¹æ®â€œå½“å‰æ—¶é—´â€ä¸â€œä¸Šæ¬¡æ›´æ–°æ—¶é—´â€çš„å·®å€¼ï¼Œè®¡ç®—å¹»å½±é˜Ÿåˆ—â€œæµå‡ºâ€äº†å¤šå°‘æ•°æ®ã€‚

- **è®ºæ–‡ä¾æ®**ï¼šå¹»å½±é˜Ÿåˆ—ä»¥æ’å®šé€Ÿç‡å‡å°‘ï¼Œè¯¥é€Ÿç‡ç•¥ä½äºçº¿é€Ÿï¼ˆLine Rateï¼‰ã€‚
    
- **å‚æ•°è®¾å®š**ï¼šUno å°†æ’æ°´é€Ÿç‡è®¾å®šä¸ºç‰©ç†å¸¦å®½çš„ **90%** ã€‚
    

C++

```
void Queue::update_phantom_state(simtime_picoseconds current_time) {
    // 1. è®¡ç®—æ—¶é—´å·®
    simtime_picoseconds time_diff = current_time - _last_update_time;
    
    if (time_diff > 0) {
        // 2. è®¡ç®—è¿™æ®µæ—¶é—´å†…åº”è¯¥æµå‡ºå¤šå°‘å­—èŠ‚
        // Drain Rate = Link Rate * 0.9
        double drained_bits = time_diff * (_link_rate * 0.9); 
        double drained_bytes = drained_bits / 8.0;

        // 3. æ›´æ–°å¹»å½±é˜Ÿåˆ—é•¿åº¦ (ä¸èƒ½å°äº 0)
        _phantom_bytes -= drained_bytes;
        if (_phantom_bytes < 0) {
            _phantom_bytes = 0;
        }

        // 4. æ›´æ–°æ—¶é—´æˆ³
        _last_update_time = current_time;
    }
}
```

#### B. å…¥é˜Ÿä¸æ ‡è®°é€»è¾‘ (Enqueue & Marking)

å½“ä¸€ä¸ªçœŸå®çš„æ•°æ®åŒ…åˆ°è¾¾äº¤æ¢æœºç«¯å£æ—¶ï¼Œä½ éœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **åŒæ­¥çŠ¶æ€**ï¼šè°ƒç”¨ä¸Šé¢çš„ `update_phantom_state`ã€‚
    
2. **è™šæ‹Ÿå…¥é˜Ÿ**ï¼šå°†åŒ…å¤§å°åŠ åˆ° `_phantom_bytes` ä¸Š ã€‚
    
3. **ECN åˆ¤å†³**ï¼šä½¿ç”¨å¹»å½±é˜Ÿåˆ—çš„é•¿åº¦ï¼ˆè€Œéç‰©ç†é˜Ÿåˆ—é•¿åº¦ï¼‰æ¥å†³å®šæ˜¯å¦æ‰“ ECN æ ‡è®° ã€‚
    

C++

```
void Queue::receivePacket(Packet* pkt) {
    simtime_picoseconds now = eventlist().now();
    
    // === 1. æ›´æ–°å¹»å½±é˜Ÿåˆ—æ°´ä½ ===
    update_phantom_state(now);

    // === 2. è™šæ‹Ÿå…¥é˜Ÿ ===
    // æ— è®ºç‰©ç†é˜Ÿåˆ—æ˜¯å¦æ»¡ï¼Œå¹»å½±é˜Ÿåˆ—éƒ½è¦å¢åŠ è®¡æ•°
    _phantom_bytes += pkt->size();

    // === 3. ECN æ ‡è®°é€»è¾‘ (åŸºäºå¹»å½±é˜Ÿåˆ—) ===
    // è®¾å®šé˜ˆå€¼: Min = 25% of BDP, Max = 75% of BDP [cite: 574]
    double p_min = _phantom_max_size * 0.25; 
    double p_max = _phantom_max_size * 0.75;
    
    bool mark_packet = false;

    if (_phantom_bytes > p_max) {
        mark_packet = true; // è¶…è¿‡é«˜æ°´ä½ï¼Œå¿…æ ‡è®°
    } else if (_phantom_bytes > p_min) {
        // åœ¨ Min å’Œ Max ä¹‹é—´ï¼Œä½¿ç”¨ RED (Random Early Detection) è®¡ç®—æ¦‚ç‡
        double probability = (_phantom_bytes - p_min) / (p_max - p_min);
        if (random_double() < probability) {
            mark_packet = true;
        }
    }

    if (mark_packet) {
        pkt->set_flags(pkt->flags() | ECN_CE); // CE = Congestion Experienced
    }

    // === 4. ç‰©ç†å…¥é˜Ÿé€»è¾‘ (æ ‡å‡†çš„ Tail-Drop) ===
    if (_bytes_in_queue + pkt->size() > _max_buffer_size) {
        drop(pkt); // ç‰©ç†ç¼“å­˜æ»¡äº†ï¼Œå¿…é¡»ä¸¢åŒ…
    } else {
        _bytes_in_queue += pkt->size();
        send_to_link(pkt); // å‘é€åŒ…
    }
}
```

### 3. ä¸ºä»€ä¹ˆæ’æ°´é€Ÿç‡æ˜¯ 90%ï¼Ÿ(The "Headroom" Logic)

ä½ å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆä¸è®¾ä¸º 100%ã€‚

- **åŸç†**ï¼šå¦‚æœå¹»å½±é˜Ÿåˆ—çš„æ’æ°´é€Ÿåº¦ï¼ˆ0.9ï¼‰æ¯”ç‰©ç†é˜Ÿåˆ—ï¼ˆ1.0ï¼‰æ…¢ï¼Œé‚£ä¹ˆå½“æµé‡æŒç»­åˆ°æ¥æ—¶ï¼Œå¹»å½±é˜Ÿåˆ—ä¼šæ¯”ç‰©ç†é˜Ÿåˆ—**å…ˆæ»¡**ï¼ˆæˆ–è€…è¯´æ°´ä½æ›´é«˜ï¼‰ã€‚
    
- **æ•ˆæœ**ï¼šECN æ ‡è®°ä¼šåŸºäºè¾ƒé«˜çš„å¹»å½±æ°´ä½æå‰è§¦å‘ã€‚å‘é€ç«¯æ”¶åˆ° ECN åä¼šå‡é€Ÿã€‚
    
- **é›¶æ’é˜Ÿ (Near-zero queuing)**ï¼šç”±äºå‡é€Ÿä¿¡å·å‘å‡ºçš„éå¸¸æ—©ï¼Œç‰©ç†é˜Ÿåˆ—å¯èƒ½å®é™…ä¸Šè¿˜æ˜¯ç©ºçš„ï¼Œæˆ–è€…åªæœ‰å¾ˆå°‘çš„åŒ…ã€‚è¿™ä¸ºæ—¶å»¶æ•æ„Ÿçš„å°æµï¼ˆIntra-DC RPCsï¼‰é¢„ç•™äº†ç‰©ç†å¸¦å®½çš„ "Headroom"ï¼Œä»è€Œå®ç°æä½çš„æ’é˜Ÿæ—¶å»¶ ã€‚
    

### 4. å‘é€ç«¯é…åˆ (UnoCC Sender Logic)

å¹»å½±é˜Ÿåˆ—ä»…ä»…æ˜¯ç”Ÿæˆä¿¡å·ï¼Œå‘é€ç«¯ï¼ˆUnoCCï¼‰å¿…é¡»æ­£ç¡®è§£è¯»è¿™ä¸ªä¿¡å·ã€‚è¿™åœ¨è®ºæ–‡çš„ Algorithm 1 ä¸­æœ‰æè¿°ã€‚

å‘é€ç«¯éœ€è¦åŒºåˆ†**ä¸¤ç§æ‹¥å¡**ï¼š

1. **çœŸå®æ‹¥å¡ (Physical Congestion)**ï¼šç‰©ç†é˜Ÿåˆ—çœŸçš„å µäº†ï¼Œå»¶è¿Ÿå¾ˆé«˜ã€‚
    
2. **å¹»å½±æ‹¥å¡ (Phantom Congestion)**ï¼šç‰©ç†é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œä½†å¹»å½±é˜Ÿåˆ—è®¡ç®—å‡ºéœ€è¦å‡é€Ÿã€‚
    

**ä»£ç å®ç°é€»è¾‘ (Sender Side):**

C++

```
// å½“æ”¶åˆ°å¸¦æœ‰ ECN æ ‡è®°çš„ ACK æ—¶
if (ack.ecn_marked) {
    // è®¡ç®—å½“å‰æµ‹å¾—çš„æ’é˜Ÿå»¶è¿Ÿ
    // RTT_base æ˜¯è¯¥è·¯å¾„çš„æœ€å°ç‰©ç† RTT
    simtime_picoseconds queue_delay = measured_rtt - rtt_base;

    double md_scale = 1.0;

    // åˆ¤æ–­æ˜¯å¦ä»…ä»…æ˜¯å¹»å½±æ‹¥å¡
    // å¦‚æœæ’é˜Ÿå»¶è¿Ÿæ¥è¿‘ 0 (æˆ–è€…éå¸¸å°)ï¼Œè¯´æ˜ç‰©ç†é˜Ÿåˆ—æ˜¯ç©ºçš„
    if (queue_delay <= TINY_THRESHOLD) {
        // [cite: 386, 387]
        // æ­¤æ—¶æ˜¯å¹»å½±é˜Ÿåˆ—åœ¨å‘Šè­¦ï¼Œä½†ç‰©ç†è·¯å†µè¿˜è¡Œ
        // é‡‡ç”¨ "Gentle Reduction" (æ¸©å’Œå‡å°‘)
        md_scale = 0.3; 
    } else {
        // [cite: 391, 392]
        // ç‰©ç†é˜Ÿåˆ—ä¹Ÿå µäº†ï¼Œå¿…é¡»å…¨é€Ÿé™ä½
        md_scale = 1.0;
    }

    // æ‰§è¡Œä¹˜æ³•å‡å° (MD)
    // MD_ECN æ˜¯æ ‡å‡†è¡°å‡å› å­
    cwnd = cwnd * (1 - MD_ECN * md_scale);
}
```

### æ€»ç»“ (Summary for Implementation)

è¦å¤ç° Phantom Queueï¼Œä½ éœ€è¦åœ¨ `htsim` ä¸­åšä¸¤å¤„ä¸»è¦ä¿®æ”¹ï¼š

1. **åœ¨ Switch/Queue ç±»ä¸­**ï¼šå®ç°ä¸€ä¸ªæ¯”ç‰©ç†å‡ºå£é€Ÿç‡æ…¢ 10% çš„è™šæ‹Ÿè®¡æ•°å™¨ï¼Œå¹¶åŸºäºè¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥æ‰“ ECN æ ‡è®°ã€‚
    
2. **åœ¨ Sender/UnoCC ç±»ä¸­**ï¼šåœ¨å¤„ç† ECN æ—¶æ£€æŸ¥ RTTã€‚å¦‚æœ RTT å¾ˆä½ä½†æœ‰ ECNï¼Œè¯´æ˜æ˜¯å¹»å½±é˜Ÿåˆ—åœ¨èµ·ä½œç”¨ï¼Œæ­¤æ—¶åº”å°†çª—å£å‡å°‘çš„åŠ›åº¦ï¼ˆMD Factorï¼‰ä¹˜ä»¥ 0.3ã€‚
    

è¿™æ˜¯ Uno èƒ½å¤ŸåŒæ—¶å¤„ç† Intra-DCï¼ˆä½å»¶è¿Ÿï¼‰å’Œ Inter-DCï¼ˆå¤§ååï¼‰æµé‡ä¸”äº’ä¸å¹²æ‰°çš„å…³é”®æ‰€åœ¨ã€‚