### 0. 摘要原文翻译

跨数据中心的RDMA扩展受阻于低效的丢包恢复机制 1。高往返时延（RTT）和大带宽时延积（BDP）严重削弱了默认的Go-back-N（GBN）重传性能，而RDMA网卡（RNIC）的硬件限制又使得选择性重传（SR）的实际部署变得不可行 2。本文提出了LR2，一种网内协作重传机制，它克服了RNIC的限制以实现可靠的长距离RDMA 3。LR2的核心在于解耦重传责任：在RNIC处保留快速循环的GBN，而在数据中心互联（DCI）交换机处重建长距离的SR 4。此外，DCI交换机通过近发送端快速反馈和近接收端本地重传，独立地屏蔽数据中心内部的丢包 5。为了实现该设计，LR2在长途链路两端部署了轻量级的可编程模块：（1）近接收端的Depot模块，负责维护节省缓存的乱序重排和备份池；（2）近发送端的Sentry模块，负责生成快速丢包反馈并过滤冗余重传 6。我们在Tofino交换机上实现了LR2，并通过测试床实验和大规模模拟进行了评估 7。LR2在不引入巨大系统开销的情况下，显著降低了流完成时间（FCT）并提高了带宽效率 8。

---

### 1. 方法动机 (Motivation)

#### a) 作者为什么提出这个方法？

随着云服务扩展到多个地理区域，跨数据中心（Inter-DC）扩展RDMA以支持全局高效通信成为趋势 9。然而，长距离链路（数百至数千公里）不仅带来了高延迟，还伴随着物理层损伤导致的频繁非拥塞丢包，这使得鲁棒的丢包恢复机制变得至关重要 10。

#### b) 现有方法的痛点/不足是什么？

1. **GBN的性能崩溃：** 现有的RoCEv2主要依赖RNIC上的GBN。在长距离、高BDP场景下，GBN面临长反馈回路和大量冗余重传（不仅重传丢失包，还重传其后所有包），导致带宽浪费和高恢复延迟 11。
    
2. **RNIC实现SR的硬件瓶颈：** 选择性重传（SR）虽然高效，但需要维护每个Queue Pair (QP) 的位图（Bitmap）和重排序Buffer。在长距离大BDP下，SR状态空间急剧膨胀（例如100Gbps/40ms需要500个slot的位图） 12。商用RNIC通常只有几MB的片上SRAM，无法存储这些海量状态 13。
    
3. **现有网内方案的局限：** * _本地重传（如NetRT）：_ 需要在交换机缓存大量数据，面对大BDP时Buffer不够用 14。
    
    - _本地反馈（如SLR）：_ 虽然能快速发现丢包，但受限于长链路的高延迟，反馈到达发送端仍然很慢 15。
        

#### c) 方法假设或隐含前提

- **分层网络结构：** Inter-DC路径天然具有分层结构（短延迟的Intra-DC段 + 长延迟的Inter-DC骨干网） 16。
    
- **交换机能力：** DCI位置的可编程交换机（如Tofino）拥有比RNIC更大的Buffer（MB级别 vs KB级别），可以承担部分卸载任务 17。
    

---

### 2. 方法设计 (Method Methodology)

LR2的核心思想是**“协作式重传解耦”**：保留RNIC简单的GBN逻辑，利用DCI交换机“欺骗”双方，在网络内部重构出SR的效果。

#### a) 方法流程总结 (Pipeline)

这是一个双端协作的Pipeline，涉及发送端DCI（Sentry）和接收端DCI（Depot）：

1. **正常传输：**
    
    - 源RNIC发送数据包。
        
    - **Sentry（近发送端）**：记录流状态，放行数据包进入长途链路。
        
    - **Depot（近接收端）**：
        
        - 若数据包**顺序到达**：转发给目的RNIC，同时**拷贝**一份到“备份池（Backup Pool）”用于处理下游DC内部丢包 18。
            
        - 若检测到**长途链路乱序/丢包**（即 $PSN > ePSN$）：进入“重排序模式”。
            
2. **长途丢包恢复（核心流程）：**
    
    - **Depot缓冲与反馈：** Depot发现乱序，将后续到来的乱序包暂存在“重排序池（Reordering Pool）”中，不发给目的RNIC（防止触发接收端GBN NACK）。同时，Depot生成一个携带丢失信息的**Depot-NACK**发回给发送端 19。
        
    - **Sentry过滤与触发：** Sentry收到Depot-NACK，解析出丢失的序列号，记录在本地位图（Bitmap）中。Sentry向源RNIC转发这个NACK（伪装成普通NACK） 20。
        
    - **源RNIC响应：** 源RNIC收到NACK，误以为是普通GBN请求，开始**重传所有后续包** 21。
        
    - **Sentry拦截（SR Filter）：** 重传包到达Sentry。Sentry检查位图：
        
        - 如果是位图中记录的**丢失包** -> **放行**并高优先级转发。
            
        - 如果是位图中未记录的**冗余包**（即Depot已经缓存的） -> **直接丢弃** 22。
            
    - **Depot恢复：** 丢失包到达Depot，填补空缺。Depot将重排序池中的包按序释放给目的RNIC 23。
        
3. **本地丢包恢复（Intra-DC）：**
    
    - 如果是发送端DC内部丢包：Sentry直接检测乱序，立刻生成**Sentry-NACK**让RNIC重传，甚至不经过长途链路 24。
        
    - 如果是接收端DC内部丢包：接收端RNIC发送NACK，Depot拦截该NACK，直接从“备份池”中重传数据，不通知源端 25。
        

#### b) 模块功能差异与协同

|**模块**|**位置**|**核心职责**|**关键数据结构**|
|---|---|---|---|
|**Sentry**|发送端DCI交换机|**过滤与触发**：拦截冗余重传，向源端注入NACK。|**SR Filter (Bitmap)**: 记录Depot报告的缺口；<br><br>  <br><br>**ePSN_s**: 维护发送端期望序列号。|
|**Depot**|接收端DCI交换机|**缓存与代理**：缓存乱序包，缓存已发包备份。|**Reordering Pool**: 存乱序包；<br><br>  <br><br>**Backup Pool**: 存已发包；<br><br>  <br><br>**Dual-Register**: 追踪SR状态。|

#### c) 关键算法/公式解释

- **双寄存器机制 (Dual-Register Mechanism)** 26：
    
    - 为了在Depot端避免使用昂贵的Bitmap，作者使用了两个寄存器：
        
        1. $ePSN$：期望接收的下一个顺序包序号。
            
        2. $ePSN\_D$：已接收到的最大乱序包序号边界。
            
    - **作用：** 当丢包发生时，$ePSN$ 停滞，$ePSN\_D$ 继续增长。Depot-NACK 只需携带 $ePSN\_D$ 和 $ePSN$ 之间的差距（Gap），Sentry 收到后据此更新自己的 Bitmap。这种设计极大地压缩了交换机与交换机之间的控制信令开销。
        
- **性能边界分析公式** 27：
    
    - $S_{LR2} \approx 1 + \frac{Ne_l}{(1+\delta)(1+2D \cdot B \cdot e_l)}$
        
    - 该公式证明了LR2的FCT（流完成时间）受长途链路丢包率 $e_l$ 的影响被因子 $(1+2D \cdot B \cdot e_l)$ 缩小了。简单来说，**BDP越大，LR2相对于GBN的优势越明显**。
        

---

### 3. 与其他方法对比

#### a) 本质不同

- **与GBN相比：** LR2在长途链路上表现为SR（只重传丢失的），但对端系统保持GBN兼容。
    
- **与纯RNIC SR相比：** LR2将SR的状态维护（Bitmap、Buffer）转移到了交换机上，解决了RNIC内存不足的问题。
    
- **与NetRT（全卸载）相比：** LR2不需要在交换机上维护全量的TCP/RDMA协议栈或巨大的全量Buffer，只在必要时（丢包时）介入，属于"On-demand"协作。
    

#### b) 创新点

1. **协作式重传解耦：** 首次提出将SR逻辑拆分：RNIC做“傻瓜式”重传，Sentry做“过滤器”，Depot做“暂存区”。
    
2. **极简的状态管理：** 提出Dual-Register设计，避免了在接收端交换机维护复杂的Bitmap。
    
3. **无缝兼容性：** 利用BTH头部的保留位，无需修改现有的RoCEv2包格式，RNIC只需极小的逻辑调整（识别NACK类型）。
    

#### c) 适用场景

- **高延迟、高带宽的长距离链路（WAN/DCI）**。
    
- **有一定丢包率的网络**（物理层损伤不可避免）。
    
- **使用商用可编程交换机**（如Tofino）和普通RNIC的数据中心。
    

#### d) 方法对比表

|**特性**|**GBN (默认)**|**RNIC-based SR (如IRN)**|**NetRT (交换机重传)**|**LR2 (本文)**|
|---|---|---|---|---|
|**长距离吞吐/FCT**|差 (冗余重传多)|高 (理想情况)|高|**高 (接近理想SR)**|
|**RNIC内存需求**|低|**极高 (Bitmap/Context)**|低|**低 (GBN兼容)**|
|**交换机Buffer需求**|无|无|**高 (需缓存所有在途包)**|**中 (仅需缓存乱序/少量备份)**|
|**部署难度**|无|需定制RNIC硬件|需特定ToR支持|**需可编程DCI交换机**|

---

### 4. 实验表现与优势

#### a) 实验设计

- **平台：** 硬件测试床（Tofino交换机 + Intel E810 RNIC + DPDK模拟长延迟链路） + NS-3大规模仿真 28282828。
    
- **参数：** 延迟 400us-800us（约80-160km），丢包率 $10^{-3}$ 到 $10^{-2}$ 29。
    
- **负载：** Websearch, Hadoop, Alistorage 等真实流量分布 30303030。
    

#### b) 关键结果

- **FCT降低：** 在Websearch负载下，LR2相比GBN降低了 **40-70%** 的平均FCT，尾部延迟降低了 **36-74%** 31313131。
    
- **长流优势明显：** 对于大于500KB的大流，FCT几乎减半 32。
    
- **链路利用率：** LR2的链路有效利用率接近理想的Lossless基线（~60%），而GBN因为重传冗余只有~50% 33。
    

#### c) 最佳表现场景

- **高丢包率场景：** 当丢包率达到 $10^{-2}$ 时，优势最大 34。
    
- **超长距离：** 随着距离增加（延迟>800us），LR2相对于GBN的提升更加稳定且显著 35。
    

#### d) 局限性

- **Buffer依赖：** 虽然比NetRT少，但仍需占用交换机SRAM。在极端高丢包率（$10^{-2}$）下，Buffer占用可能达到MB级别（接近Tofino单Pipeline限制） 36。
    
- **Recirculation开销：** 实现中使用了交换机的Recirculation（回环）特性来处理Buffer，这可能会消耗额外的交换机吞吐量 37。
    

---

### 5. 学习与应用

#### a) 复现建议

- **关键步骤：**
    
    1. **P4编程：** 需要约1000行P4代码 38。重点是实现Parser解析BTH保留位，以及Ingress/Egress的Mirror逻辑。
        
    2. **模拟Buffer：** 在Tofino上，Buffer池通常通过将端口配置为Loopback模式并在Egress做Mirror来实现（Recirculation） 39。
        
    3. **NACK构造：** 利用Tofino的Packet Gen或截断原包Payload并在Egress修改Header来构造NACK 40。
        

#### b) 注意细节

- **Timeout设置 ($T_{out}$)**：论文建议设置为下游DC基础RTT的**2倍**。太短会导致不必要的重传，太长会降低恢复速度 41。
    
- **Buffer大小配置：** 重排序池建议覆盖长途链路的BDP（测试床中约1MB），备份池覆盖Intra-DC BDP（约50KB） 42。
    

#### c) 迁移性

- 该方法的**“发送端过滤 + 接收端缓存”**思想可以迁移到其他基于GBN的传输协议优化中，不仅限于RoCEv2，例如QUIC在某些受限硬件上的卸载。
    

---

### 6. 总结

#### a) 核心思想

**利用DCI交换机进行近端过滤和远端缓存，以GBN的低成本实现SR的高性能。**

#### b) 速记版 Pipeline (3步)

1. **接收端DCI (Depot)**：发现丢包，暂存乱序包，**只发NACK**告诉发送端缺什么。
    
2. **发送端RNIC**：收到NACK，以为要全重传，**傻傻地重传所有**数据。
    
3. **发送端DCI (Sentry)**：根据NACK信息，**拦截并丢弃**多余的重传包，只放行丢失包。